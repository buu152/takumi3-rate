<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TAKUMI³ Best40 / CSV</title>

<style>
:root{
  --bg1:#2f3550;
  --bg2:#0f1117;
  --card1:rgba(255,255,255,0.10);
  --card2:rgba(255,255,255,0.06);
  --panel:rgba(20,24,40,0.92);
  --panel2:rgba(14,16,26,0.92);
  --border:rgba(255,255,255,0.10);
  --text:#ffffff;
  --muted:rgba(255,255,255,0.78);
  --accent:rgba(138,180,255,0.55);
  --accent2:rgba(138,180,255,0.22);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:"Segoe UI","Noto Sans JP",system-ui,sans-serif;
  background:
    radial-gradient(circle at top, rgba(138,180,255,0.18), transparent 55%),
    radial-gradient(circle at 20% 20%, rgba(255,214,61,0.10), transparent 40%),
    radial-gradient(circle at 80% 30%, rgba(107,255,149,0.08), transparent 45%),
    radial-gradient(circle at top, var(--bg1), var(--bg2));
  color:var(--text);
}

.wrap{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:clamp(10px, 1.8vh, 22px);
}

.container{
  width:min(1080px, 96vw);
  padding:clamp(14px, 1.9vh, 26px);
  background:linear-gradient(180deg,var(--card1),var(--card2));
  border:1px solid var(--border);
  border-radius:22px;
  box-shadow:0 0 30px rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
}

h1{
  text-align:center;
  font-size:clamp(24px, 3.3vw, 38px);
  margin:0 0 clamp(10px, 1.4vh, 18px);
  letter-spacing:0.5px;
}

label{
  display:block;
  font-size:clamp(14px, 2.0vw, 18px);
  margin:clamp(8px, 1.1vh, 14px) 0 clamp(6px, 0.8vh, 10px);
  color:var(--muted);
}

/* ===== 共通ナビ（単曲と同じ） ===== */
.nav{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:center;
  margin:-4px 0 clamp(12px, 1.6vh, 18px);
  flex-wrap:wrap;
}
.nav a{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:140px;
  padding:10px 14px;
  border-radius:16px;
  text-decoration:none;
  font-weight:800;
  color:var(--text);
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--border);
  box-shadow:
    0 10px 30px rgba(0,0,0,0.28),
    inset 0 1px 0 rgba(255,255,255,0.06);
}
.nav a:hover{ opacity:.92; }
.nav a:focus{
  outline:none;
  border-color:rgba(138,180,255,0.35);
  box-shadow:
    0 0 0 4px rgba(138,180,255,0.18),
    0 10px 30px rgba(0,0,0,0.30),
    inset 0 1px 0 rgba(255,255,255,0.06);
}
.nav a.active{
  background:linear-gradient(180deg, rgba(138,180,255,0.26), rgba(14,16,26,0.92));
  border-color:rgba(138,180,255,0.30);
}
/* =============================== */

.grid{
  display:grid;
  grid-template-columns: 1.2fr 0.8fr;
  gap:12px;
  align-items:start;
}
@media (max-width: 960px){
  .grid{ grid-template-columns: 1fr; }
}

.card{
  border:1px solid var(--border);
  border-radius:18px;
  background:linear-gradient(180deg,var(--card1),var(--card2));
  box-shadow:0 10px 26px rgba(0,0,0,0.28);
  backdrop-filter: blur(10px);
  padding:12px;
}

h2{
  margin:0 0 8px;
  font-size:clamp(16px, 2.2vw, 22px);
}
h3{
  margin:0 0 10px;
  font-size:clamp(15px, 2.0vw, 18px);
}

.muted{
  color:var(--muted);
  font-size:12px;
  line-height:1.55;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:10px;
}

input[type="file"]{
  width:auto;
  max-width:100%;
  color:var(--muted);
}

button{
  appearance:none;
  border:none;
  cursor:pointer;
  padding:10px 14px;
  border-radius:16px;
  font-weight:800;
  color:var(--text);
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--border);
  box-shadow:
    0 10px 26px rgba(0,0,0,0.25),
    inset 0 1px 0 rgba(255,255,255,0.06);
}
button:hover{ opacity:.92; }
button:active{ transform: translateY(1px); }
button:focus{
  outline:none;
  border-color:rgba(138,180,255,0.35);
  box-shadow:
    0 0 0 4px rgba(138,180,255,0.18),
    0 10px 30px rgba(0,0,0,0.30),
    inset 0 1px 0 rgba(255,255,255,0.06);
}

textarea{
  width:100%;
  border-radius:16px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  color:var(--text);
  padding:12px;
  outline:none;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  font-size:12px;
  line-height:1.45;
  min-height:180px;
  box-shadow:
    0 10px 26px rgba(0,0,0,0.25),
    inset 0 1px 0 rgba(255,255,255,0.06);
}
textarea:focus{
  border-color:rgba(138,180,255,0.35);
  box-shadow:
    0 0 0 4px rgba(138,180,255,0.18),
    0 10px 30px rgba(0,0,0,0.30),
    inset 0 1px 0 rgba(255,255,255,0.06);
}

.chk{
  display:flex;
  gap:8px;
  align-items:center;
  color:var(--muted);
  font-size:12px;
  user-select:none;
}
.chk input{ transform: scale(1.05); }

.log{
  margin-top:10px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(0,0,0,0.18);
  color:var(--muted);
  font-size:12px;
  white-space:pre-wrap;
}

.kpi{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:6px;
}
.kpi .box{
  border:1px solid var(--border);
  background:rgba(0,0,0,0.14);
  border-radius:16px;
  padding:10px 12px;
}
.k{ font-size:12px; color:var(--muted); }
.v{ font-size:22px; font-weight:900; margin-top:2px; }

/* ===== tables ===== */
.section{
  margin-top:12px;
}
.table-wrap{
  overflow:auto;
  border-radius:18px;
  border:1px solid var(--border);
  background:rgba(0,0,0,0.12);
}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width:860px;
  font-size:13px;
}
th, td{
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,0.08);
  white-space:nowrap;
}
thead th{
  position:sticky;
  top:0;
  z-index:2;
  background:linear-gradient(180deg, rgba(20,24,40,0.95), rgba(14,16,26,0.95));
  color:rgba(255,255,255,0.92);
}
tbody tr:hover{ background:rgba(255,255,255,0.04); }

.right{ text-align:right; }
.center{ text-align:center; }

/* difficulty tags */
.tag{
  display:inline-block;
  padding:2px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  line-height:18px;
  border:1px solid rgba(255,255,255,0.12);
}
.tag.master{ background:#7b2cff; color:#fff; }           /* 紫 */
.tag.insanity{ background:#fff2c8; color:#6b4a00; border-color:rgba(0,0,0,0.12); } /* クリーム */
.tag.ravage{ background:#e53935; color:#fff; }           /* 赤 */

.note{
  margin-top:10px;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.03);
  color:var(--muted);
  font-size:12px;
  line-height:1.6;
}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  background:rgba(138,180,255,0.18);
  border:1px solid rgba(138,180,255,0.28);
}
</style>
</head>

<body>
<div class="wrap">
  <div class="container">
    <h1>Best40 / CSV読み込み</h1>

    <div class="nav" aria-label="ページ切替">
      <a href="index.html">単曲レート</a>
      <a class="active" href="best40.html">Best40 / CSV</a>
    </div>

    <div class="grid">
      <div class="card">
        <h2>CSVを読み込む</h2>
        <div class="muted">
          CSV形式（左から）：<span class="badge">曲名</span>, <span class="badge">難易度名</span>, <span class="badge">定数</span>, …, <span class="badge">スコア</span><br/>
          ※ bookmarklet は <span class="badge">曲名,難易度名,定数,スコア</span> を送ります
        </div>

        <div class="row">
          <input type="file" id="csvFile" accept=".csv,text/csv" />
          <button id="btnLoadSample" type="button">サンプル貼り付け</button>
          <button id="btnClear" type="button">クリア</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <textarea id="csvText" placeholder="ここにCSVを貼り付けてもOK（bookmarklet経由なら自動入力されます）"></textarea>
        </div>

        <div class="row">
          <button id="btnParse" type="button">解析してBest40生成</button>

          <label class="chk">
            <input type="checkbox" id="chkIgnoreUnknown" checked />
            songDataに存在しない譜面は無視（推奨）
          </label>
        </div>

        <div id="parseLog" class="log">未解析</div>
      </div>

      <div class="card">
        <h2>集計</h2>

        <div class="kpi">
          <div class="box">
            <div class="k">Best40 合計</div>
            <div class="v" id="sumRate">-</div>
          </div>
          <div class="box">
            <div class="k">Best40 平均</div>
            <div class="v" id="avgRate">-</div>
          </div>
          <div class="box">
            <div class="k">40位レート</div>
            <div class="v" id="cutRate">-</div>
          </div>
          <div class="box">
            <div class="k">表示</div>
            <div class="v" id="countInfo">-</div>
          </div>
        </div>

        <div class="note">
          候補曲は「40位を更新するために必要なスコア（概算）」も表示します。<br/>
          ※必要スコアは単曲レートが単調増加である前提で二分探索しています。
        </div>
      </div>
    </div>

    <div class="section card">
      <h2>Best40</h2>
      <div class="table-wrap">
        <table id="best40Table">
          <thead>
            <tr>
              <th class="center">#</th>
              <th>曲名</th>
              <th>難易度</th>
              <th class="center">Lv</th>
              <th class="right">スコア</th>
              <th class="right">単曲レート</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="section card">
      <h2>候補曲（Best40外）</h2>
      <div class="table-wrap">
        <table id="candidatesTable">
          <thead>
            <tr>
              <th class="center">#</th>
              <th>曲名</th>
              <th>難易度</th>
              <th class="center">Lv</th>
              <th class="right">現在スコア</th>
              <th class="right">現在レート</th>
              <th class="right">枠更新に必要スコア</th>
              <th class="right">更新後レート</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="note">
        MASTER=紫 / INSANITY=クリーム / RAVAGE=赤 で表示します。<br/>
        （bookmarklet経由のCSVに定数が入るので songData がなくても動きます）
      </div>
    </div>

  </div>
</div>

<script src="songData.js"></script>
<script>
/* =========================
   単曲ページと同じレート式
   ========================= */
function calcSingleRateBridge({ level, score }) {
  let s = Number(score);
  if (Number.isNaN(s)) return NaN;
  s = Math.max(0, Math.min(1000000, s));

  const lv = Number(level);
  if (!Number.isFinite(lv)) return NaN;

  let rate = 0;

  if (s < 800000) {
    rate = 0;
  } else if (s < 970000) {
    const adj = (s - 800000) / 170000;
    rate = (lv * adj) / 34;
  } else {
    let adj = 0;
    if (s < 990000) adj = (s - 970000) / 20000;
    else if (s < 995000) adj = 1 + (s - 990000) / 10000;
    else if (s < 999000) adj = 1.5 + (s - 995000) / 8000;
    else if (s < 1000000) adj = 2 + (s - 999000) / 10000;
    else adj = 2.1;

    rate = (lv + adj) / 34;
  }
  return rate;
}

/* 定数表記（"14+"等）の解釈：必要なら +0.7 を変更 */
function parseLevelText(levelText) {
  const t = String(levelText ?? "").trim();
  if (!t) return null;
  const m = t.match(/^(\d+(?:\.\d+)?)\s*\+$/);
  if (m) return Number(m[1]) + 0.7;
  const n = Number(t);
  return Number.isFinite(n) ? n : null;
}

function normalizeDiff(s) {
  return String(s ?? "").trim().toUpperCase().replace(/\s+/g, "");
}
function diffTagClass(diffName) {
  const d = normalizeDiff(diffName);
  if (d.includes("MASTER")) return "master";
  if (d.includes("INSANITY")) return "insanity";
  if (d.includes("RAVAGE")) return "ravage";
  return "";
}

/* CSVパース（簡易・ダブルクォート対応） */
function parseCSVText(text) {
  const rows = [];
  let cur = "", inQ = false, row = [];
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') {
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (!inQ && ch === ",") {
      row.push(cur); cur = "";
    } else if (!inQ && (ch === "\n" || ch === "\r")) {
      if (ch === "\r" && text[i+1] === "\n") i++;
      row.push(cur); cur = "";
      if (row.some(v => String(v).trim() !== "")) rows.push(row);
      row = [];
    } else {
      cur += ch;
    }
  }
  row.push(cur);
  if (row.some(v => String(v).trim() !== "")) rows.push(row);
  return rows;
}

/* エントリ抽出：曲名,難易度,定数(あれば),...,スコア */
function extractEntriesFromRows(rows) {
  const entries = [];
  for (const r of rows) {
    if (!r || r.length < 2) continue;

    const songTitle = String(r[0] ?? "").trim();
    const diffName  = String(r[1] ?? "").trim();
    if (!songTitle || !diffName) continue;

    // 3列目が定数っぽければ拾う
    let level = null;
    if (r.length >= 3) {
      const lvTry = parseLevelText(r[2]);
      if (lvTry != null) level = lvTry;
    }

    // スコア：右端から数値
    let score = null;
    for (let i = r.length - 1; i >= 0; i--) {
      const v = String(r[i] ?? "").trim().replace(/,/g, "");
      if (/^\d+$/.test(v)) { score = Number(v); break; }
    }
    if (score == null) continue;

    entries.push({ songTitle, diffName, level, score });
  }
  return entries;
}

function fmtScore(n) {
  const x = Number(n);
  if (!Number.isFinite(x)) return "-";
  return x.toLocaleString("ja-JP");
}
function fmtRate(n) {
  const x = Number(n);
  if (!Number.isFinite(x)) return "-";
  return x.toFixed(4);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* songData 保険（現状使わなくてもOK） */
function findChart(songTitle, diffName){
  // songDataが「level -> 曲名配列」形式だと逆引きが難しいためここは未実装のまま
  // CSVに定数がある運用なら問題なし
  return null;
}

function buildRatedList(entries, opts) {
  const ignoreUnknown = !!opts.ignoreUnknown;
  const rated = [];
  let unknown = 0;

  for (const e of entries) {
    // 1) CSVに定数があるならそれを使う
    if (e.level != null) {
      const rate = calcSingleRateBridge({ level: e.level, score: e.score });
      rated.push({ ...e, rate, unknown:false });
      continue;
    }

    // 2) 定数が無い場合は songData 側
    const chart = findChart(e.songTitle, e.diffName);
    if (!chart) {
      unknown++;
      if (!ignoreUnknown) rated.push({ ...e, level:null, rate:NaN, unknown:true });
      continue;
    }
    const rate = calcSingleRateBridge({ level: chart.level, score: e.score });
    rated.push({ ...e, level: chart.level, rate, unknown:false });
  }

  return { rated, unknown };
}

/* 候補曲：必要スコア（二分探索） */
function estimateRequiredScore({ targetRate, level, currentScore }) {
  if (!Number.isFinite(targetRate)) return null;
  if (!Number.isFinite(Number(level))) return null;

  const maxScore = 1010000;
  const rateAt = (score) => calcSingleRateBridge({ level, score });

  const curRate = rateAt(currentScore);
  if (curRate >= targetRate) return { neededScore: currentScore, newRate: curRate };

  const maxRate = rateAt(maxScore);
  if (maxRate < targetRate) return null;

  let lo = Math.max(0, currentScore);
  let hi = maxScore;
  for (let i = 0; i < 28; i++) {
    const mid = Math.floor((lo + hi) / 2);
    const r = rateAt(mid);
    if (r >= targetRate) hi = mid;
    else lo = mid + 1;
  }
  return { neededScore: hi, newRate: rateAt(hi) };
}

const els = {
  file: document.getElementById("csvFile"),
  text: document.getElementById("csvText"),
  btnSample: document.getElementById("btnLoadSample"),
  btnClear: document.getElementById("btnClear"),
  btnParse: document.getElementById("btnParse"),
  chkIgnoreUnknown: document.getElementById("chkIgnoreUnknown"),
  log: document.getElementById("parseLog"),

  sumRate: document.getElementById("sumRate"),
  avgRate: document.getElementById("avgRate"),
  cutRate: document.getElementById("cutRate"),
  countInfo: document.getElementById("countInfo"),

  bestBody: document.querySelector("#best40Table tbody"),
  candBody: document.querySelector("#candidatesTable tbody"),
};

function renderTables(best40, candidates, cutRate, totalCount) {
  els.bestBody.innerHTML = "";
  els.candBody.innerHTML = "";

  best40.forEach((x, idx) => {
    const tr = document.createElement("tr");
    const tagCls = diffTagClass(x.diffName);
    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td>${escapeHtml(x.songTitle)}</td>
      <td><span class="tag ${tagCls}">${escapeHtml(x.diffName)}</span></td>
      <td class="center">${x.level ?? "-"}</td>
      <td class="right">${fmtScore(x.score)}</td>
      <td class="right">${fmtRate(x.rate)}</td>
    `;
    els.bestBody.appendChild(tr);
  });

  candidates.forEach((x, idx) => {
    const tr = document.createElement("tr");
    const tagCls = diffTagClass(x.diffName);
    const needStr = x.needed ? fmtScore(x.needed.neededScore) : "-";
    const newRateStr = x.needed ? fmtRate(x.needed.newRate) : "-";
    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td>${escapeHtml(x.songTitle)}</td>
      <td><span class="tag ${tagCls}">${escapeHtml(x.diffName)}</span></td>
      <td class="center">${x.level ?? "-"}</td>
      <td class="right">${fmtScore(x.score)}</td>
      <td class="right">${fmtRate(x.rate)}</td>
      <td class="right">${needStr}</td>
      <td class="right">${newRateStr}</td>
    `;
    els.candBody.appendChild(tr);
  });

  const sum = best40.reduce((a, b) => a + (Number(b.rate) || 0), 0);
  const avg = best40.length ? sum / best40.length : 0;

  els.sumRate.textContent = fmtRate(sum);
  els.avgRate.textContent = fmtRate(avg);
  els.cutRate.textContent = Number.isFinite(cutRate) ? fmtRate(cutRate) : "-";
  els.countInfo.textContent = `${best40.length} / ${totalCount}`;
}

function parseAndBuild(){
  els.log.textContent = "";

  const text = els.text.value || "";
  const rows = parseCSVText(text);
  const entries = extractEntriesFromRows(rows);

  const ignoreUnknown = els.chkIgnoreUnknown.checked;
  const { rated, unknown } = buildRatedList(entries, { ignoreUnknown });

  const ok = rated.filter(x => Number.isFinite(Number(x.rate)));
  ok.sort((a,b) => (Number(b.rate) || -1) - (Number(a.rate) || -1));

  const best40 = ok.slice(0, 40);
  const cutRate = best40.length === 40
    ? Number(best40[39].rate)
    : (best40[best40.length-1]?.rate ?? NaN);

  const out = ok.slice(40, 120);
  const candidates = out.map(x => {
    const needed = (best40.length === 40)
      ? estimateRequiredScore({ targetRate: cutRate + 1e-10, level: x.level, currentScore: x.score })
      : null;
    return { ...x, needed };
  });

  renderTables(best40, candidates, cutRate, ok.length);

  els.log.textContent =
`CSV行数: ${rows.length}
有効エントリ: ${entries.length}
レート計算できた譜面: ${ok.length}
未一致: ${unknown}
Best40: ${best40.length}
候補表示: ${candidates.length}
（※ bookmarklet経由なら定数が入るので songData無しでもOK）`;
}

/* ===== UI wiring ===== */
els.file.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  const text = await f.text();
  els.text.value = text;
});

els.btnSample.addEventListener("click", () => {
  els.text.value =
`曲名,難易度名,定数,スコア
"ARCANAA ?","MASTER","15",995000
"tundra","INSANITY","14+",971984
`;
});

els.btnClear.addEventListener("click", () => {
  els.text.value = "";
  els.bestBody.innerHTML = "";
  els.candBody.innerHTML = "";
  els.sumRate.textContent = "-";
  els.avgRate.textContent = "-";
  els.cutRate.textContent = "-";
  els.countInfo.textContent = "-";
  els.log.textContent = "未解析";
});

els.btnParse.addEventListener("click", parseAndBuild);

/* ===== 追加：#csv= を読み込んで自動反映 ===== */
(function autoLoadFromHash(){
  const h = location.hash || "";
  if (!h.startsWith("#csv=")) return;
  try{
    const csv = decodeURIComponent(h.slice(5));
    els.text.value = csv;
    els.btnParse.click();
    history.replaceState(null, "", location.pathname + location.search);
  }catch(e){
    els.log.textContent = "hash読込に失敗: " + e;
  }

/* ===== 追加：window.name からCSVを読み込んで自動反映 ===== */
(function autoLoadFromWindowName(){
  const wn = window.name || "";
  const prefix = "TAKUMI_B40_CSV_V1\n";
  if (!wn.startsWith(prefix)) return;

  try{
    const csv = wn.slice(prefix.length);
    els.text.value = csv;
    els.btnParse.click();

    // 読み終わったら消す（次回誤爆防止）
    window.name = "";
  }catch(e){
    els.log.textContent = "window.name読込に失敗: " + e;
  }
})();

})();
</script>
</body>
</html>
